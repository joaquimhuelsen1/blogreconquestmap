{% extends "base.html" %}

{% block title %}Teste de Reconquista - Reconquest Blog{% endblock %}

{% block extra_css %}
<style>
    .quiz-container {
        max-width: 800px;
        margin: 3rem auto;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }
    
    .quiz-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .quiz-header h1 {
        color: #C60000;
        margin-bottom: 1rem;
    }
    
    .quiz-form label {
        font-weight: 500;
    }
    
    .quiz-form .btn-primary {
        background-color: #C60000;
        border-color: #C60000;
    }
    
    .quiz-form .btn-primary:hover {
        background-color: #a50000;
        border-color: #a50000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="quiz-container">
        <div class="quiz-header">
            <h1>Teste de Reconquista</h1>
            <p class="lead">Responda as perguntas abaixo com sinceridade para obter uma análise personalizada da sua situação.</p>
        </div>
        
        <form id="quiz-form" class="quiz-form">
            <div class="mb-4">
                <label for="fullName" class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="fullName" name="fullName" required>
            </div>
            
            <div class="mb-4">
                <label for="age" class="form-label">Idade</label>
                <input type="number" class="form-control" id="age" name="age" min="18" max="100" required>
            </div>
            
            <div class="mb-4">
                <label for="exName" class="form-label">Nome da ex</label>
                <input type="text" class="form-control" id="exName" name="exName" required>
            </div>
            
            <div class="mb-4">
                <label for="exAge" class="form-label">Idade da ex</label>
                <input type="number" class="form-control" id="exAge" name="exAge" min="18" max="100" required>
            </div>
            
            <div class="mb-4">
                <label for="relationshipLength" class="form-label">Quanto tempo ficaram juntos:</label>
                <input type="text" class="form-control" id="relationshipLength" name="relationshipLength" required>
            </div>
            
            <div class="mb-4">
                <label for="timeSinceBreakup" class="form-label">Quanto tempo estão afastados:</label>
                <input type="text" class="form-control" id="timeSinceBreakup" name="timeSinceBreakup" required>
            </div>
            
            <div class="mb-4">
                <label for="breakupReason" class="form-label">Motivo principal do término:</label>
                <textarea class="form-control" id="breakupReason" name="breakupReason" rows="3" required></textarea>
            </div>
            
            <div class="mb-4">
                <label for="email" class="form-label">Email para contato:</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            
            <div class="mb-4">
                <label class="form-label">É aluno do Reconquest Map?</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isStudent" id="isStudentYes" value="Sim" required>
                    <label class="form-check-label" for="isStudentYes">
                        Sim
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="isStudent" id="isStudentNo" value="Não">
                    <label class="form-check-label" for="isStudentNo">
                        Não
                    </label>
                </div>
            </div>
            
            <div class="text-center mt-5">
                <button type="submit" class="btn btn-lg btn-primary px-5">Enviar Teste</button>
            </div>
        </form>
        
        <div id="quiz-results" class="mt-5 p-4 bg-light rounded text-center" style="display: none;">
            <!-- Conteúdo inserido via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const quizForm = document.getElementById('quiz-form');
        const quizResults = document.getElementById('quiz-results');
        
        quizForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Verificar se todos os campos foram preenchidos
            const fullName = document.getElementById('fullName').value;
            const age = document.getElementById('age').value;
            const exName = document.getElementById('exName').value;
            const exAge = document.getElementById('exAge').value;
            const relationshipLength = document.getElementById('relationshipLength').value;
            const timeSinceBreakup = document.getElementById('timeSinceBreakup').value;
            const breakupReason = document.getElementById('breakupReason').value;
            const email = document.getElementById('email').value;
            const isStudent = document.querySelector('input[name="isStudent"]:checked');
            
            if (!fullName || !age || !exName || !exAge || !relationshipLength || 
                !timeSinceBreakup || !breakupReason || !email || !isStudent) {
                alert('Por favor, preencha todos os campos do formulário.');
                return;
            }
            
            // Preparar dados para envio
            const formData = {
                fullName, 
                age, 
                exName, 
                exAge, 
                relationshipLength, 
                timeSinceBreakup, 
                breakupReason, 
                email, 
                isStudent: isStudent.value
            };
            
            console.log("Enviando dados para análise:", formData);
            
            // Mostrar indicador de carregamento
            const submitButton = quizForm.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...';
            
            // URL do webhook
            const webhookUrl = 'https://primary-production-eefe.up.railway.app/webhook/5d75cf8b-dbf8-4be6-afdc-25bc764cc55c';
            
            // Enviar diretamente para o webhook
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Resposta do webhook:', response);
                if (!response.ok) {
                    // Se falhar no envio direto, tentar via backend
                    console.log('Envio direto falhou, tentando via backend...');
                    return fetch('{{ url_for("main.enviar_teste") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }
                return response;
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Falha ao enviar dados');
                }
                return response.json().catch(() => ({}));
            })
            .then(data => {
                console.log('Dados recebidos:', data);
                
                // Ocultar formulário e mostrar mensagem de confirmação
                quizForm.style.display = 'none';
                
                // Exibir mensagem de confirmação
                quizResults.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        <h3 class="my-4">Obrigado pelo seu envio!</h3>
                        <div class="alert alert-success mb-4">
                            <p>Recebemos suas respostas e iremos analisá-las cuidadosamente.</p>
                            <p class="mb-0">Entraremos em contato através do email <strong>${email}</strong> com a sua análise personalizada.</p>
                        </div>
                        <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-lg mt-3">Voltar para a página inicial</a>
                    </div>
                `;
                
                quizResults.style.display = 'block';
                
                // Rolar para os resultados
                quizResults.scrollIntoView({behavior: 'smooth'});
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro ao enviar o teste. Por favor, tente novamente.');
                
                // Restaurar o botão
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            });
            
            // Opcional: salvar o email para lista de emails (em um sistema real)
            localStorage.setItem('savedEmail', email);
        });
    });
</script>
{% endblock %} 